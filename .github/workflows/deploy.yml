name: Deploy FastAPI to Azure Container Instance

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Docker Login to ACR
      run: |
        echo "${{ secrets.AZURE_REGISTRY_PASSWORD }}" | \
        docker login chezquizregister.azurecr.io \
        -u "${{ secrets.AZURE_REGISTRY_USERNAME }}" \
        --password-stdin

    - name: Build Docker image
      run: |
        docker build -t chezquizregister.azurecr.io/voicepay:latest .

    - name: Push Docker image
      run: |
        docker push chezquizregister.azurecr.io/voicepay:latest

    - name: Delete existing container (if exists)
      run: |
        az container delete \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name voicepay-api \
          --yes || true

    - name: Create Azure Container Instance
      run: |
        az container create \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --name voicepay-api-v2 \
          --image chezquizregister.azurecr.io/voicepay:latest \
          --registry-login-server chezquizregister.azurecr.io \
          --registry-username ${{ secrets.AZURE_REGISTRY_USERNAME }} \
          --registry-password ${{ secrets.AZURE_REGISTRY_PASSWORD }} \
          --dns-name-label voicepay-api-v2 \
          --ports 8000 \
          --environment-variables \
            PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }} \
            PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}